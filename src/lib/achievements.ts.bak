import type { Achievement, TeacherStats } from "@/types/achievement";

/**
 * Achievement definitions with criteria and metadata
 */
export const ACHIEVEMENT_DEFINITIONS: Record<
  string,
  Omit<Achievement, "id" | "unlockedAt" | "progress">
> = {
  top_instructor: {
    type: "top_instructor",
    name: "Top O'qituvchi",
    nameUz: "Top O'qituvchi",
    nameRu: "–¢–æ–ø –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å",
    nameEn: "Top Instructor",
    description: "4.5+ reyting bilan",
    descriptionUz: "4.5+ reyting bilan",
    descriptionRu: "–° —Ä–µ–π—Ç–∏–Ω–≥–æ–º 4.5+",
    descriptionEn: "Maintain a 4.5+ rating",
    icon: "üèÜ",
    rarity: "legendary",
  },
  thousand_students: {
    type: "1000_students",
    name: "1000+ Talaba",
    nameUz: "1000+ Talaba",
    nameRu: "1000+ –°—Ç—É–¥–µ–Ω—Ç–æ–≤",
    nameEn: "1000+ Students",
    description: "1000 dan ortiq talabaga dars berganlik",
    descriptionUz: "1000 dan ortiq talabaga dars berganlik",
    descriptionRu: "–û–±—É—á–∏–ª –±–æ–ª–µ–µ 1000 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤",
    descriptionEn: "Teach over 1000 students",
    icon: "üë•",
    rarity: "legendary",
  },
  ten_k_revenue: {
    type: "10k_revenue",
    name: "$10K Daromad",
    nameUz: "$10K Daromad",
    nameRu: "$10K –î–æ—Ö–æ–¥",
    nameEn: "$10K Revenue",
    description: "$10,000+ daromad topganlik",
    descriptionUz: "$10,000+ daromad topganlik",
    descriptionRu: "–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ $10,000+",
    descriptionEn: "Earn $10,000+",
    icon: "üí∞",
    rarity: "epic",
  },
  high_rating: {
    type: "high_rating",
    name: "Yuqori baholangan",
    nameUz: "Yuqori baholangan",
    nameRu: "–í—ã—Å–æ–∫–æ –æ—Ü–µ–Ω–µ–Ω–Ω—ã–π",
    nameEn: "Highly Rated",
    description: "4.8+ reyting va 50+ sharh",
    descriptionUz: "4.8+ reyting va 50+ sharh",
    descriptionRu: "–†–µ–π—Ç–∏–Ω–≥ 4.8+ –∏ 50+ –æ—Ç–∑—ã–≤–æ–≤",
    descriptionEn: "4.8+ rating with 50+ reviews",
    icon: "‚≠ê",
    rarity: "epic",
  },
  hundred_students: {
    type: "100_students",
    name: "100+ Talaba",
    nameUz: "100+ Talaba",
    nameRu: "100+ –°—Ç—É–¥–µ–Ω—Ç–æ–≤",
    nameEn: "100+ Students",
    description: "100 dan ortiq talabaga dars berganlik",
    descriptionUz: "100 dan ortiq talabaga dars berganlik",
    descriptionRu: "–û–±—É—á–∏–ª –±–æ–ª–µ–µ 100 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤",
    descriptionEn: "Teach over 100 students",
    icon: "üë®‚Äçüéì",
    rarity: "rare",
  },
  first_course: {
    type: "first_course",
    name: "Birinchi kurs",
    nameUz: "Birinchi kurs",
    nameRu: "–ü–µ—Ä–≤—ã–π –∫—É—Ä—Å",
    nameEn: "First Course",
    description: "Birinchi kursni e'lon qilganlik",
    descriptionUz: "Birinchi kursni e'lon qilganlik",
    descriptionRu: "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–µ—Ä–≤—ã–π –∫—É—Ä—Å",
    descriptionEn: "Published first course",
    icon: "üéì",
    rarity: "common",
  },
  five_courses: {
    type: "5_courses",
    name: "5 ta kurs",
    nameUz: "5 ta kurs",
    nameRu: "5 –∫—É—Ä—Å–æ–≤",
    nameEn: "5 Courses",
    description: "5 ta kurs yaratganlik",
    descriptionUz: "5 ta kurs yaratganlik",
    descriptionRu: "–°–æ–∑–¥–∞–Ω–æ 5 –∫—É—Ä—Å–æ–≤",
    descriptionEn: "Created 5 courses",
    icon: "üìö",
    rarity: "rare",
  },
  ten_courses: {
    type: "10_courses",
    name: "10 ta kurs",
    nameUz: "10 ta kurs",
    nameRu: "10 –∫—É—Ä—Å–æ–≤",
    nameEn: "10 Courses",
    description: "10 ta kurs yaratganlik",
    descriptionUz: "10 ta kurs yaratganlik",
    descriptionRu: "–°–æ–∑–¥–∞–Ω–æ 10 –∫—É—Ä—Å–æ–≤",
    descriptionEn: "Created 10 courses",
    icon: "üìñ",
    rarity: "epic",
  },
  early_adopter: {
    type: "early_adopter",
    name: "Dastlabki foydalanuvchi",
    nameUz: "Dastlabki foydalanuvchi",
    nameRu: "–†–∞–Ω–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    nameEn: "Early Adopter",
    description: "Platformaga birinchilardan qo'shilganlik",
    descriptionUz: "Platformaga birinchilardan qo'shilganlik",
    descriptionRu: "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏",
    descriptionEn: "Joined the platform early",
    icon: "üöÄ",
    rarity: "rare",
  },
  verified_teacher: {
    type: "verified_teacher",
    name: "Tasdiqlangan o'qituvchi",
    nameUz: "Tasdiqlangan o'qituvchi",
    nameRu: "–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å",
    nameEn: "Verified Teacher",
    description: "O'qituvchi maqomi tasdiqlangan",
    descriptionUz: "O'qituvchi maqomi tasdiqlangan",
    descriptionRu: "–°—Ç–∞—Ç—É—Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω",
    descriptionEn: "Teacher status verified",
    icon: "‚úÖ",
    rarity: "common",
  },
};

/**
 * Achievement criteria functions
 * Returns true if the achievement should be unlocked
 */
export const ACHIEVEMENT_CRITERIA: Record<
  string,
  (stats: TeacherStats) => boolean
> = {
  top_instructor: (stats) => stats.rating >= 4.5,
  thousand_students: (stats) => stats.studentCount >= 1000,
  ten_k_revenue: (stats) => stats.totalRevenue >= 10000,
  high_rating: (stats) => stats.rating >= 4.8 && stats.reviewCount >= 50,
  hundred_students: (stats) => stats.studentCount >= 100,
  first_course: (stats) => stats.courseCount >= 1,
  five_courses: (stats) => stats.courseCount >= 5,
  ten_courses: (stats) => stats.courseCount >= 10,
  early_adopter: (stats) => {
    // Check if joined before a certain date (e.g., first 100 users)
    return stats.joinedAt
      ? new Date(stats.joinedAt) < new Date("2026-02-01")
      : false;
  },
  verified_teacher: (stats) => stats.verified || false,
};

/**
 * Calculate progress towards an achievement (0-100)
 */
export const calculateAchievementProgress = (
  type: string,
  stats: TeacherStats
): number => {
  switch (type) {
    case "thousand_students":
      return Math.min((stats.studentCount / 1000) * 100, 100);
    case "hundred_students":
      return Math.min((stats.studentCount / 100) * 100, 100);
    case "ten_k_revenue":
      return Math.min((stats.totalRevenue / 10000) * 100, 100);
    case "five_courses":
      return Math.min((stats.courseCount / 5) * 100, 100);
    case "ten_courses":
      return Math.min((stats.courseCount / 10) * 100, 100);
    case "high_rating":
      const ratingProgress =
        stats.rating >= 4.8 ? 50 : (stats.rating / 4.8) * 50;
      const reviewProgress = Math.min((stats.reviewCount / 50) * 50, 50);
      return ratingProgress + reviewProgress;
    case "top_instructor":
      return Math.min((stats.rating / 4.5) * 100, 100);
    default:
      return ACHIEVEMENT_CRITERIA[type]?.(stats) ? 100 : 0;
  }
};

/**
 * Check which achievements should be unlocked based on teacher stats
 */
export function checkAchievements(stats: TeacherStats): Achievement[] {
  const achievements: Achievement[] = [];

  Object.entries(ACHIEVEMENT_CRITERIA).forEach(([type, criterion]) => {
    if (criterion(stats)) {
      const definition = ACHIEVEMENT_DEFINITIONS[type];
      if (definition) {
        achievements.push({
          id: type,
          ...definition,
          progress: 100,
          unlockedAt: new Date(),
        });
      }
    }
  });

  return achievements;
}

/**
 * Get all possible achievements with progress
 */
export function getAllAchievementsWithProgress(
  stats: TeacherStats
): Achievement[] {
  return Object.entries(ACHIEVEMENT_DEFINITIONS).map(([type, definition]) => ({
    id: type,
    ...definition,
    progress: calculateAchievementProgress(type, stats),
    unlockedAt: ACHIEVEMENT_CRITERIA[type](stats) ? new Date() : undefined,
  }));
}

/**
 * Get rarity color class
 */
export function getRarityColor(rarity: Achievement["rarity"]): string {
  switch (rarity) {
    case "common":
      return "text-gray-400 bg-gray-500/10 border-gray-500/30";
    case "rare":
      return "text-blue-400 bg-blue-500/10 border-blue-500/30";
    case "epic":
      return "text-purple-400 bg-purple-500/10 border-purple-500/30";
    case "legendary":
      return "text-yellow-400 bg-yellow-500/10 border-yellow-500/30";
    default:
      return "text-gray-400 bg-gray-500/10 border-gray-500/30";
  }
}

/**
 * Get rarity label
 */
export function getRarityLabel(rarity: Achievement["rarity"]): string {
  switch (rarity) {
    case "common":
      return "Oddiy";
    case "rare":
      return "Kamyob";
    case "epic":
      return "Ajoyib";
    case "legendary":
      return "Afsonaviy";
    default:
      return "Noma'lum";
  }
}
