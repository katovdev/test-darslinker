import type { Achievement, TeacherStats } from "@/types/achievement";

/**
 * Achievement definitions with criteria and metadata
 */
export const ACHIEVEMENT_DEFINITIONS: Record<
  string,
  Omit<Achievement, "id" | "unlockedAt" | "progress">
> = {
  top_instructor: {
    type: "top_instructor",
    name: "Top O'qituvchi",
    description: "4.5+ reyting bilan",
    icon: "ğŸ†",
    rarity: "legendary",
    points: 100,
    criteria: "Achievement unlocked",
  },
  thousand_students: {
    type: "thousand_students",
    name: "1000+ Talaba",
    description: "1000 dan ortiq talabaga dars berganlik",
    icon: "ğŸ‘¥",
    rarity: "legendary",
    points: 100,
    criteria: "Achievement unlocked",
  },
  ten_k_revenue: {
    type: "ten_k_revenue",
    name: "$10K Daromad",
    description: "$10,000+ daromad topganlik",
    icon: "ğŸ’°",
    rarity: "epic",
    points: 75,
    criteria: "Achievement unlocked",
  },
  high_rating: {
    type: "high_rating",
    name: "Yuqori baholangan",
    description: "4.8+ reyting va 50+ sharh",
    icon: "â­",
    rarity: "epic",
    points: 75,
    criteria: "Achievement unlocked",
  },
  hundred_students: {
    type: "hundred_students",
    name: "100+ Talaba",
    description: "100 dan ortiq talabaga dars berganlik",
    icon: "ğŸ‘¨â€ğŸ“",
    rarity: "rare",
    points: 50,
    criteria: "Achievement unlocked",
  },
  first_course: {
    type: "first_course",
    name: "Birinchi kurs",
    description: "Birinchi kursni e'lon qilganlik",
    icon: "ğŸ“",
    rarity: "common",
    points: 25,
    criteria: "Achievement unlocked",
  },
  five_courses: {
    type: "ten_courses",
    name: "5 ta kurs",
    description: "5 ta kurs yaratganlik",
    icon: "ğŸ“š",
    rarity: "rare",
    points: 50,
    criteria: "Achievement unlocked",
  },
  ten_courses: {
    type: "ten_courses",
    name: "10 ta kurs",
    description: "10 ta kurs yaratganlik",
    icon: "ğŸ“–",
    rarity: "epic",
    points: 75,
    criteria: "Achievement unlocked",
  },
  early_adopter: {
    type: "early_adopter",
    name: "Dastlabki foydalanuvchi",
    description: "Platformaga birinchilardan qo'shilganlik",
    icon: "ğŸš€",
    rarity: "rare",
    points: 50,
    criteria: "Achievement unlocked",
  },
};

/**
 * Achievement criteria functions
 * Returns true if the achievement should be unlocked
 */
export const ACHIEVEMENT_CRITERIA: Record<
  string,
  (stats: TeacherStats) => boolean
> = {
  top_instructor: (stats) => stats.averageRating >= 4.5,
  thousand_students: (stats) => stats.studentCount >= 1000,
  ten_k_revenue: (stats) => stats.totalRevenue >= 10000,
  high_rating: (stats) => stats.averageRating >= 4.8 && stats.totalReviews >= 50,
  hundred_students: (stats) => stats.studentCount >= 100,
  first_course: (stats) => stats.courseCount >= 1,
  five_courses: (stats) => stats.courseCount >= 5,
  ten_courses: (stats) => stats.courseCount >= 10,
  early_adopter: (stats) => {
    // Check if joined before a certain date (e.g., first 100 users)
    return stats.joinedAt
      ? new Date(stats.joinedAt) < new Date("2026-02-01")
      : false;
  },
};

/**
 * Calculate progress towards an achievement (0-100)
 */
export const calculateAchievementProgress = (
  type: string,
  stats: TeacherStats
): number => {
  switch (type) {
    case "thousand_students":
      return Math.min((stats.studentCount / 1000) * 100, 100);
    case "hundred_students":
      return Math.min((stats.studentCount / 100) * 100, 100);
    case "ten_k_revenue":
      return Math.min((stats.totalRevenue / 10000) * 100, 100);
    case "five_courses":
      return Math.min((stats.courseCount / 5) * 100, 100);
    case "ten_courses":
      return Math.min((stats.courseCount / 10) * 100, 100);
    case "high_rating":
      const ratingProgress =
        stats.averageRating >= 4.8 ? 50 : (stats.averageRating / 4.8) * 50;
      const reviewProgress = Math.min((stats.totalReviews / 50) * 50, 50);
      return ratingProgress + reviewProgress;
    case "top_instructor":
      return Math.min((stats.averageRating / 4.5) * 100, 100);
    default:
      return ACHIEVEMENT_CRITERIA[type]?.(stats) ? 100 : 0;
  }
};

/**
 * Check which achievements should be unlocked based on teacher stats
 */
export function checkAchievements(stats: TeacherStats): Achievement[] {
  const achievements: Achievement[] = [];

  Object.entries(ACHIEVEMENT_CRITERIA).forEach(([type, criterion]) => {
    if (criterion(stats)) {
      const definition = ACHIEVEMENT_DEFINITIONS[type];
      if (definition) {
        achievements.push({
          id: type,
          ...definition,
          progress: 100,
          unlockedAt: new Date(),
        });
      }
    }
  });

  return achievements;
}

/**
 * Get all possible achievements with progress
 */
export function getAllAchievementsWithProgress(
  stats: TeacherStats
): Achievement[] {
  return Object.entries(ACHIEVEMENT_DEFINITIONS).map(([type, definition]) => ({
    id: type,
    ...definition,
    progress: calculateAchievementProgress(type, stats),
    unlockedAt: ACHIEVEMENT_CRITERIA[type](stats) ? new Date() : undefined,
  }));
}

/**
 * Get rarity color class
 */
export function getRarityColor(rarity: Achievement["rarity"]): string {
  switch (rarity) {
    case "common":
      return "text-gray-400 bg-gray-500/10 border-gray-500/30";
    case "rare":
      return "text-blue-400 bg-blue-500/10 border-blue-500/30";
    case "epic":
      return "text-purple-400 bg-purple-500/10 border-purple-500/30";
    case "legendary":
      return "text-yellow-400 bg-yellow-500/10 border-yellow-500/30";
    default:
      return "text-gray-400 bg-gray-500/10 border-gray-500/30";
  }
}

/**
 * Get rarity label
 */
export function getRarityLabel(rarity: Achievement["rarity"]): string {
  switch (rarity) {
    case "common":
      return "Oddiy";
    case "rare":
      return "Kamyob";
    case "epic":
      return "Ajoyib";
    case "legendary":
      return "Afsonaviy";
    default:
      return "Noma'lum";
  }
}
